<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Website Favicon (Replaces old logo) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath fill='%23ff9f43' d='M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm0 8C73.2 8 92 26.8 92 50S73.2 92 50 92 8 73.2 8 50 26.8 8 50 8zm0 18c-8.3 0-15 6.7-15 15s6.7 15 15 15 15-6.7 15-15-6.7-15-15-15z'/%3E%3C/svg%3E">
    <title>Ultimate Egg Boiler Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff9f43;
            --secondary-color: #feca57;
            --accent-color: #ff6b6b;
            --background-color: #fff8f0;
            --text-color: #3d3d3d;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-shadow: rgba(0,0,0,0.1);
            --cozy-texture: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ff9f43' fill-opacity='0.05'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        /* Dark Mode Styles */
        body.dark-mode {
            --background-color: #1a1a1a;
            --text-color: #f0f0f0;
            --card-bg: rgba(45, 45, 45, 0.92);
            --card-shadow: rgba(0,0,0,0.3);
            --cozy-texture: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23ff9f43' fill-opacity='0.03'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Quicksand', sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 2rem 1rem;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            transition: background-color 0.4s ease, color 0.4s ease;
            position: relative;
            overflow-x: hidden;
        }
         body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: var(--cozy-texture);
            opacity: 0.1;
            z-index: -1;
        }

        .container {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: 24px;
            box-shadow: 0 10px 30px var(--card-shadow);
            border-top: 5px solid var(--primary-color);
            animation: fadeIn 1s ease-out;
        }

        h1 {
            font-family: 'Poppins', sans-serif;
            font-size: clamp(2rem, 5vw, 2.5rem);
            margin-bottom: 0.25rem;
            font-weight: 700;
        }
        .tagline { font-size: clamp(1rem, 3vw, 1.1rem); opacity: 0.8;}

        .card {
            background: var(--card-bg);
            border-radius: 24px;
            padding: 1.75rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 30px var(--card-shadow);
            animation: slideUp 0.6s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        .card:nth-of-type(2) { animation-delay: 0.1s; }
        .card:nth-of-type(3) { animation-delay: 0.2s; }
        .card:nth-of-type(4) { animation-delay: 0.3s; }


        h2.section-title {
            font-size: clamp(1.4rem, 4vw, 1.6rem);
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        /* Egg Selector */
        .egg-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1.5rem;
        }
        .egg-type {
            background: transparent;
            border-radius: 20px;
            padding: 1.5rem 1rem;
            text-align: center;
            cursor: pointer;
            border: 2px solid var(--text-color);
            opacity: 0.7;
            transition: transform 0.3s ease, opacity 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }
        .egg-type:hover {
            transform: translateY(-8px);
            opacity: 1;
            border-color: var(--primary-color);
        }
        .egg-type.selected {
            border: 3px solid var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.1);
            transform: translateY(-5px) scale(1.05);
            opacity: 1;
        }
         .egg-type i { font-size: 2.8rem; color: var(--primary-color); margin-bottom: 1rem;}
         .egg-type h3 { margin-bottom: 0.5rem; font-weight: 600; font-size: 1.1rem; }
         .egg-type p { font-size: 0.9rem; opacity: 0.8; }

        /* Advanced Settings */
        .advanced-settings { display: flex; justify-content: space-around; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .setting { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
        .setting label { font-weight: 500; }
        .setting select, .setting input {
            background: var(--background-color);
            color: var(--text-color);
            border: 2px solid var(--text-color);
            border-radius: 10px;
            padding: 0.5rem 0.75rem;
            text-align: center;
            width: 120px;
            transition: border-color 0.3s, background-color 0.3s;
        }
        .setting select:focus, .setting input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* Timer */
        .timer-display { 
            font-size: clamp(4rem, 15vw, 5rem);
            font-weight: bold;
            margin: 1.5rem 0; 
            font-family: 'Poppins', monospace; 
            color: var(--primary-color);
            transition: transform 0.3s ease;
        }
        .egg-progress { height: 10px; background: rgba(var(--text-color-rgb), 0.1); border-radius: 5px; margin: 1.5rem 0; overflow: hidden; }
        .egg-progress-bar { height: 100%; background: var(--primary-color); border-radius: 5px; width: 0%; transition: width 1s linear, background-color 0.4s; }

        .timer-controls { display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap; }
        button {
            background: var(--primary-color); border: none; color: white; padding: 0.8rem 1.75rem;
            border-radius: 50px; cursor: pointer; font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0, 0.15); display: flex; align-items: center; gap: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        button:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0, 0.2); }
        button:active { transform: translateY(1px); box-shadow: 0 2px 10px rgba(0,0,0, 0.2); }
        .stop-btn { background: var(--accent-color); }
        .reset-btn { background: #8395a7; }

        /* Optichain Boiler AI */
        #aiBoiler { text-align: left; }
        .ai-response {
            background: var(--background-color); border-radius: 15px;
            padding: 1rem; margin-top: 1rem; min-height: 120px;
            border: 1px solid rgba(var(--text-color-rgb), 0.2);
            max-height: 350px; overflow-y: auto;
        }
        .ai-message {
            margin-bottom: 0.75rem;
            padding: 0.6rem 1rem;
            border-radius: 18px;
            max-width: 85%;
            line-height: 1.5;
            animation: fadeIn 0.5s ease-out;
            clear: both;
        }
        .user-message {
            background-color: rgba(var(--primary-color-rgb), 0.15);
            margin-left: auto;
            text-align: right;
            float: right;
        }
        .ai-message-content {
            background-color: rgba(108, 92, 231, 0.1);
            margin-right: auto;
            float: left;
        }
        .ai-input-container { display: flex; margin-top: 1rem; gap: 0.75rem; }
        #aiInput {
            flex: 1; padding: 0.75rem 1.25rem;
            border-radius: 25px; border: 2px solid var(--text-color);
            background: var(--background-color); color: var(--text-color);
            transition: border-color 0.3s;
        }
        #aiInput:focus { outline: none; border-color: var(--primary-color); }
        #sendAiBtn {
            border-radius: 50%; width: 50px; height: 50px;
            padding: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
            background: #6c5ce7;
        }
        
        .nutrition-info {
            margin-top: 1rem; padding: 0.75rem 1rem;
            background: rgba(108, 92, 231, 0.08); border-radius: 10px;
            font-size: 0.9rem; border-left: 4px solid #6c5ce7;
            text-align: left;
        }
        
        /* Customization & Footer */
        .customization { display: flex; flex-direction: column; gap: 1.5rem; }
        .custom-section { width: 100%; text-align: center; }
        .custom-section h3 { margin-bottom: 0.75rem; }
        .color-picker { display: flex; gap: 1rem; justify-content: center; }
        .color-option { width: 35px; height: 35px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s, border-color 0.2s; }
        .color-option.selected { border-color: var(--background-color); transform: scale(1.15); }
        
        .dark-mode-toggle { display: flex; align-items: center; justify-content: center; gap: 1rem; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px;}
        .switch input { opacity: 0; width: 0; height: 0;}
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .4s;}
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s;}
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        .footer { text-align: center; margin-top: 2rem; padding: 1rem; font-size: 1rem; opacity: 0.8; }
        .footer a { color: var(--primary-color); text-decoration: none; font-weight: 600; transition: color 0.3s; }
        .footer a:hover { text-decoration: underline; color: var(--secondary-color); }

        /* Animations */
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .pulse { animation: pulse 1s infinite; }
        .egg-boil { animation: pulse 2s ease-in-out infinite; }

        @media (min-width: 620px) {
            .customization { flex-direction: row; justify-content: space-around; align-items: center; }
        }
    </style>
</head>
<body>
    
    <div class="container">
        <header>
            <h1>Ultimate Egg Boiler</h1>
            <p class="tagline">Perfect eggs, intelligently timed for you.</p>
        </header>

        <div class="card egg-settings">
            <h2 class="section-title"><i class="fas fa-egg"></i>1. Choose Your Doneness</h2>
            <div class="egg-selector">
                <div class="egg-type selected" data-time="240" data-id="soft">
                    <i class="fas fa-tint-slash"></i><h3>Soft Boiled</h3><p>Runny yolk</p>
                </div>
                <div class="egg-type" data-time="360" data-id="medium">
                     <i class="fas fa-adjust"></i><h3>Medium Boiled</h3><p>Creamy yolk</p>
                </div>
                <div class="egg-type" data-time="540" data-id="hard">
                     <i class="fas fa-circle"></i><h3>Hard Boiled</h3><p>Set yolk</p>
                </div>
                <div class="egg-type" data-time="720" data-id="welldone">
                     <i class="fas fa-egg"></i><h3>Well Done</h3><p>Fully cooked</p>
                </div>
            </div>
            <h2 class="section-title" style="margin-top: 2.5rem;"><i class="fas fa-sliders-h"></i>2. Fine-Tune Settings</h2>
            <div class="advanced-settings">
                <div class="setting">
                    <label for="eggSize">Egg Size</label>
                    <select id="eggSize">
                        <option value="0" selected>Medium</option>
                        <option value="60">Large (+1 min)</option>
                        <option value="120">X-Large (+2 min)</option>
                    </select>
                </div>
                <div class="setting">
                    <label for="altitude">Altitude (meters)</label>
                    <input type="number" id="altitude" value="0" step="100">
                </div>
                <div class="setting">
                    <label for="quantity">Quantity</label>
                    <input type="number" id="quantity" value="1" min="1" max="12">
                </div>
            </div>
        </div>

        <div class="card timer-container">
            <h2 class="section-title"><i class="fas fa-stopwatch"></i>3. Start Cooking</h2>
            <div class="timer-display" id="timer">04:00</div>
            <div class="egg-progress"><div class="egg-progress-bar" id="eggProgress"></div></div>
            <div class="timer-controls">
                <button class="start-btn" id="startBtn" aria-label="Start Timer"><i class="fas fa-play"></i>Start</button>
                <button class="stop-btn" id="stopBtn" aria-label="Pause Timer"><i class="fas fa-pause"></i>Pause</button>
                <button class="reset-btn" id="resetBtn" aria-label="Reset Timer"><i class="fas fa-redo"></i>Reset</button>
            </div>
        </div>

        <div class="card" id="aiBoiler">
            <h2 class="section-title"><i class="fas fa-robot"></i>Optichain Boiler AI</h2>
            <p>Chat with our AI chef for global recipes, tips, or timer commands!</p>
            <div class="ai-response" id="aiResponse">
                <div class="ai-message ai-message-content">
                    Hello! Ask me for recipes, tips, or try saying "Set timer for soft boiled eggs."
                </div>
            </div>
            <div class="ai-input-container">
                <input type="text" id="aiInput" placeholder="Ask 'Shakshuka recipe'...">
                <button id="sendAiBtn" aria-label="Send message to AI"><i class="fas fa-paper-plane"></i></button>
            </div>
            <div class="nutrition-info" id="nutritionInfo" style="display: none;">
                <!-- Content injected by JS -->
            </div>
        </div>

        <div class="card customization">
             <div class="custom-section">
                <h3>Theme Color</h3>
                <div class="color-picker" id="colorPicker">
                    <div class="color-option selected" style="background-color: #ff9f43;" data-primary="#ff9f43" data-rgb="255,159,67"></div>
                    <div class="color-option" style="background-color: #54a0ff;" data-primary="#54a0ff" data-rgb="84,160,255"></div>
                    <div class="color-option" style="background-color: #a29bfe;" data-primary="#a29bfe" data-rgb="162,155,254"></div>
                    <div class="color-option" style="background-color: #ff7979;" data-primary="#ff7979" data-rgb="255,121,121"></div>
                </div>
            </div>
             <div class="custom-section">
                <div class="dark-mode-toggle">
                    <h3>Dark Mode</h3>
                    <label class="switch">
                      <input type="checkbox" id="darkModeToggle">
                      <span class="slider"></span>
                    </label>
                </div>
             </div>
        </div>

        <div class="footer">
             <p>Enhanced with <i class="fas fa-heart" style="color: var(--accent-color);"></i> from the original by Cozytustudios</p>
             <p>Visit our showcase: <a href="https://cozytusstudio-showcase-9bg3htb.gamma.site/cozytustudio" target="_blank" rel="noopener noreferrer">Cozytustudio Showcase</a></p>
        </div>
    </div>

    <audio id="alarmSound" src="https://assets.mixkit.co/sfx/preview/mixkit-kitchen-microwave-1106.mp3" preload="auto"></audio>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements ---
        const UIElements = {
            timerDisplay: document.getElementById('timer'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            resetBtn: document.getElementById('resetBtn'),
            eggTypes: document.querySelectorAll('.egg-type'),
            alarmSound: document.getElementById('alarmSound'),
            colorPicker: document.getElementById('colorPicker'),
            eggProgress: document.getElementById('eggProgress'),
            eggSize: document.getElementById('eggSize'),
            altitude: document.getElementById('altitude'),
            quantity: document.getElementById('quantity'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            aiInput: document.getElementById('aiInput'),
            sendAiBtn: document.getElementById('sendAiBtn'),
            aiResponse: document.getElementById('aiResponse'),
            nutritionInfo: document.getElementById('nutritionInfo'),
        };

        // --- Application State ---
        const AppState = {
            countdown: null,
            totalSeconds: 240,
            secondsRemaining: 240,
            baseTime: 240,
            isRunning: false,
        };
        
        // --- Data ---
        const EggData = {
            recipes: {
                shakshuka: { name: "Shakshuka (Middle East/North Africa)", description: "Eggs poached in a savory sauce of tomatoes, chili peppers, and onions. Perfect with crusty bread.", calories: 350, protein: "18g" },
                huevosrancheros: { name: "Huevos Rancheros (Mexico)", description: "Fried eggs on corn tortillas with a tomato-chili sauce, often served with beans and avocado.", calories: 420, protein: "20g" },
                tamagoyaki: { name: "Tamagoyaki (Japan)", description: "A sweet and savory Japanese rolled omelette, a staple in bento boxes.", calories: 180, protein: "12g" },
                centuryegg: { name: "Century Egg (China)", description: "A unique delicacy of preserved duck, chicken, or quail eggs, resulting in a dark, creamy yolk and jelly-like white.", calories: 155, protein: "14g" },
                scotchegg: { name: "Scotch Egg (UK)", description: "A hard or soft-boiled egg wrapped in sausage meat, coated in breadcrumbs, and fried. A picnic classic.", calories: 320, protein: "19g" },
                eggcurry: { name: "Egg Curry (India)", description: "Hard-boiled eggs in a rich, spicy curry sauce made with tomatoes, onions, and aromatic spices.", calories: 310, protein: "17g" },
                menemen: { name: "Menemen (Turkey)", description: "A traditional dish of scrambled eggs cooked with tomatoes, green peppers, and spices in a metal pan.", calories: 280, protein: "15g" }
            },
            tips: [
                "For easier peeling, add a teaspoon of baking soda or a pinch of salt to the boiling water.",
                "Use older eggs for hard boiling as the membrane is less attached to the shell, making them easier to peel.",
                "To prevent the green ring around hard-boiled yolks, cool the eggs immediately in an ice bath after cooking.",
                "Room temperature eggs are less likely to crack when submerged in boiling water.",
                "For perfect poached eggs, add a splash of vinegar to the water to help the egg whites set faster.",
                "When making an omelette, a little water or milk can make it fluffier."
            ],
            donenessKeywords: {
                soft: ["soft", "runny", "dippy", "3-min", "4-min"],
                medium: ["medium", "jammy", "creamy", "5-min", "6-min"],
                hard: ["hard", "set", "firm", "7-min", "8-min", "9-min"],
                welldone: ["well-done", "fully-cooked", "10-min", "12-min"]
            }
        };

        // --- Core Functions ---

        const formatTime = (seconds) => {
            const minutes = Math.floor(seconds / 60);
            const remainderSeconds = seconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(remainderSeconds).padStart(2, '0')}`;
        };

        const updateDisplay = () => {
            UIElements.timerDisplay.textContent = formatTime(AppState.secondsRemaining);
            const progress = AppState.totalSeconds > 0 ? ((AppState.totalSeconds - AppState.secondsRemaining) / AppState.totalSeconds) * 100 : 0;
            UIElements.eggProgress.style.width = `${progress}%`;
            document.title = `${formatTime(AppState.secondsRemaining)} - Egg Timer`;
            
            if (AppState.isRunning && !UIElements.timerDisplay.classList.contains('egg-boil')) {
                UIElements.timerDisplay.classList.add('egg-boil');
            } else if (!AppState.isRunning) {
                UIElements.timerDisplay.classList.remove('egg-boil');
            }
        };
        
        const calculateTotalSeconds = () => {
            // Add basic validation for inputs
            const altitudeValue = Math.max(0, parseInt(UIElements.altitude.value, 10) || 0);
            const quantityValue = Math.max(1, parseInt(UIElements.quantity.value, 10) || 1);
            const sizeAdjustment = parseInt(UIElements.eggSize.value, 10);

            // Water boiling point decreases ~1Â°C per 300m. Roughly add 10% cook time per 1000m.
            const altitudeAdjustment = Math.floor(AppState.baseTime * (altitudeValue / 10000));
            // Add a slight time increase for more eggs (more thermal mass to heat).
            const quantityAdjustment = Math.floor(AppState.baseTime * ((quantityValue - 1) * 0.05));

            AppState.totalSeconds = AppState.baseTime + sizeAdjustment + altitudeAdjustment + quantityAdjustment;
            resetTimer();
        };
        
        const finishTimer = () => {
            clearInterval(AppState.countdown);
            UIElements.timerDisplay.classList.add('pulse');
            UIElements.timerDisplay.classList.remove('egg-boil');
            UIElements.alarmSound.play();
            AppState.isRunning = false;
            UIElements.startBtn.innerHTML = '<i class="fas fa-play"></i> Start';
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Eggs are ready!', {
                    body: 'Your perfectly cooked eggs are waiting for you.',
                    icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cpath fill="%23ff9f43" d="M50 0C22.4 0 0 22.4 0 50s22.4 50 50 50 50-22.4 50-50S77.6 0 50 0zm0 8C73.2 8 92 26.8 92 50S73.2 92 50 92 8 73.2 8 50 26.8 8 50 8zm0 18c-8.3 0-15 6.7-15 15s6.7 15 15 15 15-6.7 15-15-6.7-15-15-15z"/%3E%3C/svg%3E'
                });
            }
        };

        const startTimer = () => {
            if (AppState.isRunning || AppState.secondsRemaining <= 0) return;
            AppState.isRunning = true;
            UIElements.startBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
            AppState.countdown = setInterval(() => {
                AppState.secondsRemaining--;
                updateDisplay();
                if (AppState.secondsRemaining <= 0) finishTimer();
            }, 1000);
        };

        const stopTimer = () => {
            if (!AppState.isRunning) return;
            clearInterval(AppState.countdown);
            AppState.isRunning = false;
        };

        const resetTimer = () => {
            stopTimer();
            AppState.secondsRemaining = AppState.totalSeconds;
            UIElements.timerDisplay.classList.remove('pulse', 'egg-boil');
            UIElements.alarmSound.pause();
            UIElements.alarmSound.currentTime = 0;
            UIElements.startBtn.innerHTML = '<i class="fas fa-play"></i> Start';
            updateDisplay();
        };

        // --- Event Handlers ---
        
        const handleEggTypeSelect = (event) => {
            const selectedEgg = event.currentTarget;
            UIElements.eggTypes.forEach(e => e.classList.remove('selected'));
            selectedEgg.classList.add('selected');
            AppState.baseTime = parseInt(selectedEgg.getAttribute('data-time'), 10);
            calculateTotalSeconds();
        };
        
        const handleThemeChange = (event) => {
            const target = event.currentTarget;
            const primary = target.getAttribute('data-primary');
            const rgb = target.getAttribute('data-rgb');
            document.documentElement.style.setProperty('--primary-color', primary);
            document.documentElement.style.setProperty('--primary-color-rgb', rgb);
            
            UIElements.colorPicker.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            target.classList.add('selected');
        };

        // --- AI Chat Functions ---
        const addMessageToChat = (message, isUser = false) => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('ai-message', isUser ? 'user-message' : 'ai-message-content');
            messageElement.innerHTML = message;
            UIElements.aiResponse.appendChild(messageElement);
            UIElements.aiResponse.scrollTop = UIElements.aiResponse.scrollHeight;
        };

        const getAIResponse = (query) => {
            query = query.toLowerCase().replace(/[^a-zA-Z0-9\s]/g, ''); // Sanitize input
            
            // 1. Check for timer commands
            if (query.includes("timer") || query.includes("set") || query.includes("start")) {
                for (const doneness in EggData.donenessKeywords) {
                    if (EggData.donenessKeywords[doneness].some(keyword => query.includes(keyword))) {
                        const targetElement = document.querySelector(`.egg-type[data-id="${doneness}"]`);
                        if (targetElement) targetElement.click();
                        startTimer();
                        return `OK, I've set and started the timer for ${doneness}-boiled eggs!`;
                    }
                }
            }
            
            // 2. Check for recipe requests
            for (const key in EggData.recipes) {
                if (query.includes(key)) {
                    const recipe = EggData.recipes[key];
                    UIElements.nutritionInfo.innerHTML = `<strong>${recipe.name}:</strong> Approx. ${recipe.calories} calories, ${recipe.protein} protein.`;
                    UIElements.nutritionInfo.style.display = 'block';
                    return recipe.description;
                }
            }

            // 3. Check for tips or general questions
            if (query.includes("tip") || query.includes("advice") || query.includes("how to")) {
                return `<strong>Cooking Tip:</strong> ${EggData.tips[Math.floor(Math.random() * EggData.tips.length)]}`;
            }

            // 4. Greetings
            if (query.startsWith("hello") || query.startsWith("hi") || query.startsWith("hey")) {
                return "Hello! I'm ready to help with recipes, tips, and timer commands.";
            }
            
            // 5. Default response
            UIElements.nutritionInfo.style.display = 'none';
            return "I'm not quite sure about that. Try asking me for a specific recipe like 'scotch egg', a cooking tip, or ask me to 'set a timer for hard boiled eggs'.";
        };

        const handleAIQuery = () => {
            const query = UIElements.aiInput.value.trim();
            if (!query) return;
            addMessageToChat(query, true);
            UIElements.aiInput.value = '';

            setTimeout(() => {
                const response = getAIResponse(query);
                addMessageToChat(response);
            }, 600);
        };
        
        // --- Initialization ---

        // Setup Event Listeners
        UIElements.startBtn.addEventListener('click', startTimer);
        UIElements.stopBtn.addEventListener('click', stopTimer);
        UIElements.resetBtn.addEventListener('click', resetTimer);
        UIElements.eggTypes.forEach(egg => egg.addEventListener('click', handleEggTypeSelect));
        UIElements.colorPicker.querySelectorAll('.color-option').forEach(option => option.addEventListener('click', handleThemeChange));
        [UIElements.eggSize, UIElements.altitude, UIElements.quantity].forEach(el => el.addEventListener('change', calculateTotalSeconds));
        UIElements.darkModeToggle.addEventListener('change', () => document.body.classList.toggle('dark-mode'));
        UIElements.sendAiBtn.addEventListener('click', handleAIQuery);
        UIElements.aiInput.addEventListener('keypress', (e) => e.key === 'Enter' && handleAIQuery());
        
        // Initial call
        if ('Notification' in window) Notification.requestPermission();
        calculateTotalSeconds();

    });
    </script>
</body>
</html>
